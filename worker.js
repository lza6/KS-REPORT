
// Kuaishou Report System - Cloudflare Worker
// Single File Implementation

export default {
    async fetch(request, env, ctx) {
        const url = new URL(request.url);

        // 1. Serve the Frontend UI
        if (url.pathname === '/' && request.method === 'GET') {
            return new Response(htmlContent, {
                headers: {
                    'content-type': 'text/html;charset=UTF-8',
                },
            });
        }

        // 2. API Proxy Endpoint
        if (url.pathname === '/api/report' && request.method === 'POST') {
            try {
                const payload = await request.json();
                let internalUserId = payload.targetId;

                // Check if the input is a numeric Kuaishou ID (userDefineId) vs internal ID
                const isNumericId = /^\d+$/.test(payload.targetId);

                if (isNumericId) {
                    // Need to resolve numeric Kuaishou ID to internal user_id via search
                    const searchUrl = 'https://www.kuaishou.com/graphql';
                    const searchHeaders = {
                        'Host': 'www.kuaishou.com',
                        'Origin': 'https://www.kuaishou.com',
                        'Referer': 'https://www.kuaishou.com/search/author?searchKey=' + encodeURIComponent(payload.targetId),
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                        'Content-Type': 'application/json',
                        'Accept': '*/*',
                        'Cookie': payload.cookies || '',
                        'kpn': 'KUAISHOU_VISION'
                    };

                    const searchQuery = {
                        operationName: "visionSearchUser",
                        variables: {
                            keyword: payload.targetId,
                            pcursor: "",
                            searchSessionId: ""
                        },
                        query: "query visionSearchUser($keyword: String, $pcursor: String, $searchSessionId: String) { visionSearchUser(keyword: $keyword, pcursor: $pcursor, searchSessionId: $searchSessionId) { result users { user_id user_name headurl user_text } pcursor searchSessionId } }"
                    };

                    const searchResp = await fetch(searchUrl, {
                        method: 'POST',
                        headers: searchHeaders,
                        body: JSON.stringify(searchQuery)
                    });

                    const searchData = await searchResp.json();

                    if (searchData?.data?.visionSearchUser?.users?.length > 0) {
                        internalUserId = searchData.data.visionSearchUser.users[0].user_id;
                    } else {
                        return new Response(JSON.stringify({
                            status: 404,
                            body: JSON.stringify({ result: 0, error_msg: 'æœªæ‰¾åˆ°è¯¥å¿«æ‰‹å·å¯¹åº”çš„ç”¨æˆ·ï¼Œè¯·æ£€æŸ¥IDæ˜¯å¦æ­£ç¡®' })
                        }), {
                            headers: { 'content-type': 'application/json', 'access-control-allow-origin': '*' }
                        });
                    }
                }

                // Target Kuaishou API
                const targetUrl = 'https://www.kuaishou.com/rest/v/report/submit';

                // Construct headers exactly as requested, but using cookies/tokens from the client payload
                const headers = {
                    'Host': 'www.kuaishou.com',
                    'Origin': 'https://www.kuaishou.com',
                    'Referer': `https://www.kuaishou.com/profile/${internalUserId}`,
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'Connection': 'keep-alive',
                    'Cookie': payload.cookies || '', // Client must provide valid cookies (did, didv, etc.) or we mock some
                    'kww': payload.kww, // The crucial token generated by client
                    'kpn': 'KUAISHOU_VISION'
                };

                // Update the data payload with resolved internal ID
                const reportData = {
                    ...payload.data,
                    reportedUserId: internalUserId,
                    targetId: internalUserId
                };

                const response = await fetch(targetUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(reportData)
                });

                const respText = await response.text();

                return new Response(JSON.stringify({
                    status: response.status,
                    headers: Object.fromEntries(response.headers),
                    body: respText,
                    resolvedUserId: internalUserId // Include resolved ID for debugging
                }), {
                    headers: {
                        'content-type': 'application/json',
                        'access-control-allow-origin': '*'
                    }
                });

            } catch (e) {
                return new Response(JSON.stringify({ error: e.message }), { status: 500 });
            }
        }

        // 3. User Profile Proxy Endpoint
        if (url.pathname === '/api/profile' && request.method === 'POST') {
            try {
                const payload = await request.json();
                let internalUserId = payload.targetId;

                // Check if the input is a numeric Kuaishou ID (userDefineId) vs internal ID (contains 'x')
                // Internal IDs look like: 3xn9cwxxrfh4ydw
                // Kuaishou IDs (userDefineId) are numeric: 4501316236
                const isNumericId = /^\d+$/.test(payload.targetId);

                if (isNumericId) {
                    // Need to resolve numeric Kuaishou ID to internal user_id via search
                    const searchUrl = 'https://www.kuaishou.com/graphql';
                    const searchHeaders = {
                        'Host': 'www.kuaishou.com',
                        'Origin': 'https://www.kuaishou.com',
                        'Referer': 'https://www.kuaishou.com/search/author?searchKey=' + encodeURIComponent(payload.targetId),
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                        'Content-Type': 'application/json',
                        'Accept': '*/*',
                        'Cookie': payload.cookies || '',
                        'kpn': 'KUAISHOU_VISION'
                    };

                    const searchQuery = {
                        operationName: "visionSearchUser",
                        variables: {
                            keyword: payload.targetId,
                            pcursor: "",
                            searchSessionId: ""
                        },
                        query: "query visionSearchUser($keyword: String, $pcursor: String, $searchSessionId: String) { visionSearchUser(keyword: $keyword, pcursor: $pcursor, searchSessionId: $searchSessionId) { result users { user_id user_name headurl user_text } pcursor searchSessionId } }"
                    };

                    const searchResp = await fetch(searchUrl, {
                        method: 'POST',
                        headers: searchHeaders,
                        body: JSON.stringify(searchQuery)
                    });

                    const searchData = await searchResp.json();

                    if (searchData?.data?.visionSearchUser?.users?.length > 0) {
                        // Find exact match by userDefineId or take first result
                        internalUserId = searchData.data.visionSearchUser.users[0].user_id;
                    } else {
                        return new Response(JSON.stringify({
                            status: 404,
                            body: JSON.stringify({ result: 0, error_msg: 'æœªæ‰¾åˆ°è¯¥å¿«æ‰‹å·å¯¹åº”çš„ç”¨æˆ·ï¼Œè¯·æ£€æŸ¥IDæ˜¯å¦æ­£ç¡®' })
                        }), {
                            headers: { 'content-type': 'application/json' }
                        });
                    }
                }

                // Now fetch profile with the internal user_id
                const targetUrl = 'https://www.kuaishou.com/rest/v/profile/user';

                const headers = {
                    'Host': 'www.kuaishou.com',
                    'Origin': 'https://www.kuaishou.com',
                    'Referer': `https://www.kuaishou.com/profile/${internalUserId}`,
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'Connection': 'keep-alive',
                    'Cookie': payload.cookies || '',
                    'kww': payload.kww,
                    'kpn': 'KUAISHOU_VISION'
                };

                const response = await fetch(targetUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ user_id: internalUserId })
                });

                const respText = await response.text();

                return new Response(JSON.stringify({
                    status: response.status,
                    body: respText,
                    resolvedUserId: internalUserId // Include resolved ID for debugging
                }), {
                    headers: { 'content-type': 'application/json' }
                });

            } catch (e) {
                return new Response(JSON.stringify({ error: e.message }), { status: 500 });
            }
        }

        return new Response('Not Found', { status: 404 });
    }
};

// ==========================================
// FRONTEND HTML CONTENT
// ==========================================
const htmlContent = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KS-REPORT | æ ¸å¿ƒæ‰§æ³•ç³»ç»Ÿ</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF3506; /* Kuaishou Red */
            --primary-dim: rgba(255, 53, 6, 0.3);
            --accent: #00F260;
            --bg-dark: #050507;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-muted: #666666;
            --card-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', system-ui, sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(255, 53, 6, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(0, 50, 255, 0.05) 0%, transparent 40%);
        }

        /* Scanlines */
        body::after {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 10;
        }

        .container {
            position: relative;
            z-index: 2;
            width: 1100px;
            max-width: 95%;
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 24px;
            height: 85vh;
        }

        .card {
            background: rgba(15, 15, 20, 0.6);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 40px;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            position: relative;
            transition: border-color 0.3s;
        }

        .card:hover {
            border-color: rgba(255, 53, 6, 0.3);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 28px;
            margin: 0 0 8px 0;
            background: linear-gradient(90deg, #fff, #aaa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
        }

        h2 {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--primary);
            margin: 0 0 30px 0;
            opacity: 0.8;
            font-family: 'JetBrains Mono', monospace;
        }

        .input-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }

        label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-weight: 600;
        }

        label span.tip {
            color: var(--primary);
            cursor: pointer;
            opacity: 0.7;
        }
        label span.tip:hover { opacity: 1; text-decoration: underline; }

        input, textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 16px;
            color: #fff;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(255, 53, 6, 0.15);
            background: rgba(0, 0, 0, 0.7);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            line-height: 1.6;
        }
        
        /* Cookie Input Specifics */
        .cookie-box textarea {
            min-height: 80px;
            color: #aaffaa;
            font-size: 11px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #a31600);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            letter-spacing: 1px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            margin-top: auto;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(255, 53, 6, 0.3);
        }

        .btn-primary::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }

        .btn-primary:hover::after {
            left: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(255, 53, 6, 0.5);
        }

        .btn-primary:active { transform: scale(0.98); }

        .btn-primary.loading {
            background: #333;
            cursor: wait;
            opacity: 0.8;
            box-shadow: none;
        }

        /* Right Panel: Terminal */
        .terminal-header {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        .dot { width: 10px; height: 10px; border-radius: 50%; }
        .red { background: #ff5f56; }
        .yellow { background: #ffbd2e; }
        .green { background: #27c93f; }

        .terminal-window {
            flex: 1;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: #00f260;
            overflow-y: auto;
            position: relative;
        }

        .log-entry {
            margin-bottom: 8px;
            display: flex;
            opacity: 0;
            animation: fadeIn 0.3s forwards;
        }
        
        .log-entry.error { color: #ff3506; }
        .log-entry.warn { color: #ffbd2e; }
        .log-entry.info { color: #5dade2; }

        .timestamp {
            opacity: 0.5;
            margin-right: 12px;
            min-width: 70px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-box {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-val { font-size: 24px; font-weight: 800; color: #fff; }
        .stat-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-top: 5px; }

        /* Profile Preview Card */
        .preview-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            display: none; /* Hidden by default */
            animation: fadeIn 0.4s ease-out;
            backdrop-filter: blur(10px);
        }
        .preview-content { display: flex; gap: 15px; align-items: flex-start; }
        .preview-avatar { 
            width: 60px; height: 60px; border-radius: 50%; 
            border: 2px solid var(--primary); 
            object-fit: cover;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .preview-info { flex: 1; }
        .preview-name { 
            font-size: 16px; font-weight: 700; color: #fff; margin-bottom: 4px;
            display: flex; align-items: center; gap: 5px;
        }
        .preview-id { font-size: 12px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
        .preview-bio {
            font-size: 12px; color: #aaa; margin-top: 8px; line-height: 1.4;
            background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px;
        }
        .preview-stats {
            display: flex; gap: 15px; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 8px;
        }
        .p-stat { font-size: 11px; color: #888; }
        .p-stat b { color: #ddd; margin-left: 2px; }
        
        .check-btn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1);
            color: #ccc; padding: 0 10px; border-radius: 4px; cursor: pointer;
            font-size: 12px; margin-left: 10px; transition: all 0.2s;
        }
        .check-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }

    </style>
</head>
<body>

<div class="container">
    <!-- Config Panel -->
    <div class="card">
        <h1>STRIKE // æ ¸å¿ƒæ‰“å‡»</h1>
        <h2>ä¸¾æŠ¥æ‰§æ³•æ§åˆ¶å°</h2>
        
        <div class="input-section">
            <div>
                <label>ç›®æ ‡ç”¨æˆ· UID <span class="tip" onclick="pasteClipboard('targetId')">[ç²˜è´´]</span> <button class="check-btn" onclick="checkTarget()">ğŸ” é¢„è§ˆç›®æ ‡</button></label>
                <input type="text" id="targetId" value="3xn9cwxxrfh4ydw" placeholder="è¾“å…¥å¿«æ‰‹ç”¨æˆ·ID...">
                
                <div id="previewCard" class="preview-card">
                    <!-- Populated by JS -->
                    <div style="text-align: center; color: #666; font-size: 12px;">ç‚¹å‡»â€œé¢„è§ˆç›®æ ‡â€åŠ è½½ä¿¡æ¯</div>
                </div>
            </div>

            <div class="cookie-box">
                <label>å®‰å…¨ä»¤ç‰Œ (Cookie) <span class="tip" onclick="pasteClipboard('cookieInput')">[è‡ªåŠ¨å¡«å……]</span></label>
                <textarea id="cookieInput" placeholder="å¿…é¡»ï¼åœ¨æ­¤ç²˜è´´æ‚¨çš„ 'did=...; didv=...' å­—ç¬¦ä¸²ã€‚ä¸¾æŠ¥éœ€è¦æœ‰æ•ˆçš„ Cookieã€‚"></textarea>
            </div>

            <div>
                <label>è¿è§„è¯¦æƒ…</label>
                <textarea id="reportDetail"></textarea>
            </div>
        </div>

        <div class="input-section" style="margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label>æ‰§è¡Œæ¬¡æ•° (å¾ªç¯)</label>
                    <input type="number" id="loopCount" value="10" min="1" placeholder="ä¾‹å¦‚: 10">
                </div>
                <div>
                    <label>é—´éš”æ—¶é—´ (ç§’) <span class="tip">[å»ºè®® 2-5s]</span></label>
                    <input type="number" id="loopInterval" value="3" min="1" placeholder="ä¾‹å¦‚: 3">
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="btn-primary" id="startBtn" onclick="startReport()" style="flex: 1;">
                å•æ¬¡æ‰“å‡» // ç«‹å³æ‰§è¡Œ
            </button>
            <button class="btn-primary" id="autoBtn" onclick="startAutoReport()" style="flex: 1; background: linear-gradient(135deg, #FF9800, #F44336);">
                è‡ªåŠ¨æ‰“å‡» // å¾ªç¯æ¨¡å¼
            </button>
        </div>
    </div>

    <!-- Terminal Panel -->
    <div class="card" style="background: rgba(0,0,0,0.85);">
        <div class="terminal-header">
            <div class="dot red"></div>
            <div class="dot yellow"></div>
            <div class="dot green"></div>
        </div>
        
        <div class="stats-row">
            <div class="stat-box">
                <div class="stat-val" id="reqCount">0</div>
                <div class="stat-label">è¯·æ±‚æ•°</div>
            </div>
            <div class="stat-box">
                <div class="stat-val" style="color:var(--primary)" id="errCount">0</div>
                <div class="stat-label">é”™è¯¯æ•°</div>
            </div>
        </div>

        <div class="terminal-window" id="console">
            <div class="log-entry"><span class="timestamp">[ç³»ç»Ÿ]</span> ç³»ç»Ÿå·²åˆå§‹åŒ–ã€‚å°±ç»ªã€‚</div>
            <div class="log-entry info"><span class="timestamp">[æç¤º]</span> è¯·æä¾›æœ‰æ•ˆçš„ Cookie ä»¥é¿å… 109 é”™è¯¯ã€‚</div>
        </div>
    </div>
</div>

<script>
    // PRESETS
    const DEFAULT_REASON = "è‡´å®¡æ ¸ä¸“å‘˜ï¼š\\nè¯·åŠ¡å¿…äººå·¥é˜…è¯»ï¼è¯¥è´¦å·æå…¶ç‹¡çŒ¾ï¼Œè¡¨é¢çœ‹æ˜¯åœ¨åˆ†äº«æ¸¸æˆé…ç½®ï¼Œå®åˆ™æ˜¯åˆ©ç”¨é»‘äº§ä¸“ç”¨æœ¯è¯­ï¼ˆé»‘è¯ï¼‰è§„é¿ç³»ç»Ÿæ£€æµ‹ ï¼Œè¿›è¡Œå¤–æŒ‚æ¨å¹¿å’Œè¯ˆéª—å¼•æµã€‚\\n\\n1ï¸âƒ£ è§†è§‰ç”»é¢å®é”¤ï¼šéæ³•ç¯¡æ”¹å®¢æˆ·ç«¯æ•°æ®\\nè§†é¢‘ä¸­çš„äº®åº¦å·²çªç ´æ­£å¸¸æ›å…‰æé™ï¼Œä¸”æ— é˜´å½±ï¼Œå±äºå…¸å‹çš„â€œé€è§†/é™¤è‰â€ä¿®æ”¹ã€‚\\n\\n2ï¸âƒ£ è¯æœ¯è§£ç ï¼šé»‘äº§ä¸“ç”¨è¯­\\næ‰€è°“â€œé…ç½®æ–‡ä»¶â€å³å¤–æŒ‚è„šæœ¬ï¼Œâ€œV1/V2â€ä»£è¡¨å¤–æŒ‚æš´åŠ›ç¨‹åº¦ã€‚\\n\\nä¸¥è‚ƒè¯‰æ±‚ï¼š\\nè¯¥è´¦å·è¡Œä¸ºæ¶‰å«Œè§¦çŠ¯ã€Šåˆ‘æ³•ã€‹å¸®ä¿¡ç½ªï¼Œè¯·å¹³å°æ°¸ä¹…å°ç¦ï¼è‹¥æ¨è¯¿ä¸å¤„ç†ï¼Œæˆ‘å°†å‘ç½‘ä¿¡åŠä¸¾æŠ¥å¹³å°å¤±èŒï¼";
    document.getElementById('reportDetail').value = DEFAULT_REASON;

    // PRESET COOKIE (User Provided)
    const DEFAULT_COOKIE = "";
    
    // Set default cookie directly
    document.getElementById('cookieInput').value = DEFAULT_COOKIE;

    // UTILS
    function log(msg, type = '') {
        const consoleEl = document.getElementById('console');
        const now = new Date().toLocaleTimeString('en-US', {hour12: false});
        const entry = document.createElement('div');
        entry.className = \`log-entry \${type}\`;
        entry.innerHTML = \`<span class="timestamp">[\${now}]</span> \${msg}\`;
        consoleEl.appendChild(entry);
        consoleEl.scrollTop = consoleEl.scrollHeight;
    }

    async function pasteClipboard(id) {
        try {
            const text = await navigator.clipboard.readText();
            document.getElementById(id).value = text;
            log('å‰ªè´´æ¿å†…å®¹å·²ç²˜è´´ã€‚', 'info');
        } catch (e) {
            log('æ— æ³•è®¿é—®å‰ªè´´æ¿ã€‚', 'warn');
        }
    }

    let reqs = 0;
    let errors = 0;

    async function checkTarget() {
        const targetId = document.getElementById('targetId').value.trim();
        const cookieStr = document.getElementById('cookieInput').value.trim();
        const card = document.getElementById('previewCard');

        if (!targetId) { log("è¯·è¾“å…¥ç›®æ ‡ ID", "warn"); return; }
        
        log("ğŸ” æ­£åœ¨è·å–ç›®æ ‡ä¿¡æ¯...", "info");
        card.style.display = 'block';
        card.innerHTML = '<div style="text-align:center; padding:20px;">âŒ› åŠ è½½ä¸­...</div>';

        try {
            const response = await fetch('/api/profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    targetId: targetId,
                    cookies: cookieStr,
                    kww: "PnGU+9+Y8008S+nH0U+0mjPf8fP08f+98f+nLlwnrIP9+Sw/ZFGfzY+eGlGf+f+e4SGfbYP0QfGnLFwBLU80mYGAq9PAW9+erl8fcF8nL7G0Y0+eGM+0+0wn+YPfHIGfr98eY0+0WhG/cI8eHlP0Ll+ecFweWlPf+YPnGIG/LI8nQf+eq7PBPh808f8/Zl+0DI+/pS80S0PeGA80QjG/zS+I=="
                })
            });
            
            const result = await response.json();
            if (result.status !== 200) throw new Error("API é”™è¯¯: " + result.status);
            
            let body;
            try { body = JSON.parse(result.body); } catch(e) { body = result.body; }

            if (body.result !== 1) throw new Error(body.error_msg || "è·å–å¤±è´¥/Cookieæ— æ•ˆ");

            const p = body.userProfile.profile;
            const s = body.userProfile.ownerCount;

            card.innerHTML = \`
                <div class="preview-content">
                    <img src="\${p.headurl}" class="preview-avatar">
                    <div class="preview-info">
                        <div class="preview-name">\${p.user_name}</div>
                        <div class="preview-id">ID: \${p.user_id}</div>
                        <div class="preview-bio">\${p.user_text || 'æ— ç®€ä»‹'}</div>
                    </div>
                </div>
                <div class="preview-stats">
                    <div class="p-stat">ç²‰ä¸ <b>\${s.fan}</b></div>
                    <div class="p-stat">è·èµ <b>\${s.like}</b></div>
                    <div class="p-stat">å…³æ³¨ <b>\${s.follow}</b></div>
                </div>
            \`;
            log("âœ… ç›®æ ‡ä¿¡æ¯è·å–æˆåŠŸ: " + p.user_name, "info");

        } catch (e) {
            log("âŒ " + e.message, "error");
            card.innerHTML = '<div style="text-align:center; color:#ff3506; padding:10px;">âŒ è·å–å¤±è´¥: ' + e.message + '</div>';
        }
    }

    // AUTO REPORT LOGIC
    let isAutoRunning = false;

    async function startAutoReport() {
        if (isAutoRunning) {
            isAutoRunning = false;
            log("ğŸ›‘ ç”¨æˆ·ä¸­æ­¢äº†è‡ªåŠ¨æ‰“å‡»ä»»åŠ¡ã€‚", "warn");
            return;
        }

        const count = parseInt(document.getElementById('loopCount').value) || 10;
        const interval = parseInt(document.getElementById('loopInterval').value) || 3;
        const btn = document.getElementById('autoBtn');
        const startBtn = document.getElementById('startBtn');

        isAutoRunning = true;
        btn.innerHTML = 'ğŸ›‘ åœæ­¢è‡ªåŠ¨æ‰“å‡»';
        btn.classList.add('loading');
        startBtn.disabled = true;

        log("=========================================");
        log("ğŸš€ å¯åŠ¨è‡ªåŠ¨æ‰“å‡»æ¨¡å¼", "info");
        log("ğŸ¯ ç›®æ ‡æ¬¡æ•°: " + count + " æ¬¡ | â±ï¸ é—´éš”: " + interval + " ç§’", "info");
        log("=========================================");

        for (let i = 1; i <= count; i++) {
            if (!isAutoRunning) break;

            log("\\n[å¾ªç¯ " + i + "/" + count + "] æ­£åœ¨æ‰§è¡Œ...");
            await startReport(true); // true = silent mode (no button reset)

            if (i < count && isAutoRunning) {
                log("â³ ç­‰å¾… " + interval + " ç§’å†·å´...", "info");
                await new Promise(r => setTimeout(r, interval * 1000));
            }
        }

        isAutoRunning = false;
        btn.innerHTML = 'è‡ªåŠ¨æ‰“å‡» // å¾ªç¯æ¨¡å¼';
        btn.classList.remove('loading');
        startBtn.disabled = false;
        log("\\nâœ… è‡ªåŠ¨æ‰“å‡»åºåˆ—å·²ç»“æŸã€‚", "info");
    }

    async function startReport(isAuto = false) {
        const btn = document.getElementById('startBtn');
        const targetId = document.getElementById('targetId').value.trim();
        const cookieStr = document.getElementById('cookieInput').value.trim();
        const detail = document.getElementById('reportDetail').value;

        if (!targetId || !cookieStr) { 
            log("ä¸­æ­¢ï¼šç¼ºå°‘å¿…è¦ä¿¡æ¯ã€‚ç›®æ ‡ ID å’Œ Cookie ä¸ºå¿…å¡«é¡¹ã€‚", "error");
            errors++; updateStats();
            return; 
        }

        // Save cookie for convenience
        localStorage.setItem('ks_cookie', cookieStr);

        if (!isAuto) {
            btn.classList.add('loading');
            btn.innerHTML = 'âš¡ æ‰§è¡Œä¸­...';
            log("-----------------------------------------");
            log("å¼€å§‹æ‰§è¡Œç›®æ ‡ï¼š" + targetId);
        }
        
        // log("æ­£åœ¨éªŒè¯å‡­æ®..."); // Reduce spam in auto mode

        try {
            // Hardcoded fingerprint/token logic would go here
            // For now, we trust the user provided KWW kww logic is embedded/or we rely on cookies
            // The previous "HARDCODED_KWW" is likely expired too, but the cookie is the main gate.
            
            // Construct Payload
            const payload = {
                targetId: targetId,
                kww: "PnGU+9+Y8008S+nH0U+0mjPf8fP08f+98f+nLlwnrIP9+Sw/ZFGfzY+eGlGf+f+e4SGfbYP0QfGnLFwBLU80mYGAq9PAW9+erl8fcF8nL7G0Y0+eGM+0+0wn+YPfHIGfr98eY0+0WhG/cI8eHlP0Ll+ecFweWlPf+YPnGIG/LI8nQf+eq7PBPh808f8/Zl+0DI+/pS80S0PeGA80QjG/zS+I==", // Keep or update if possible
                cookies: cookieStr,
                data: {
                    "extraPhotoId": "",
                    "page": "PROFILE",
                    "reportDetail": detail,
                    "reportItem": 203,
                    "reportType": 2,
                    "reportedUserId": targetId,
                    "targetId": targetId
                }
            };

            // log("è¿æ¥å·²å»ºç«‹ã€‚æ­£åœ¨å‘é€æ•°æ®...", "info");

            const response = await fetch('/api/report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            reqs++;
            const result = await response.json();
            
            if (result.status === 200) {
                 // Parse inner body
                 let inner;
                 try { inner = JSON.parse(result.body); } catch(e) { inner = result.body; }
                 
                 if (inner.result === 1) {
                     log("âœ… æˆåŠŸï¼šä¸¾æŠ¥å·²é€è¾¾ã€‚", "info");
                     if (!isAuto) btn.innerHTML = 'âœ… ä»»åŠ¡å®Œæˆ';
                 } else if (inner.result === 109) {
                     log("âŒ å¤±è´¥ï¼šè®¤è¯è¢«æ‹’ç» (Cookie æ— æ•ˆ)", "error");
                     errors++;
                     if (!isAuto) btn.innerHTML = 'âŒ è®¤è¯å¤±è´¥';
                     if (isAuto) isAutoRunning = false; // Stop auto on auth fail
                 } else {
                     log("âš ï¸ çŠ¶æ€ï¼š" + (JSON.stringify(inner) || "æœªçŸ¥"));
                     if (!isAuto) btn.innerHTML = 'âš ï¸ å·²å®Œæˆ';
                 }
            } else {
                 log("âŒ ä¸Šæ¸¸é”™è¯¯ï¼š" + (result.status || "æœªçŸ¥"), "error");
                 if (result.body) {
                     try {
                        const bodyObj = JSON.parse(result.body);
                        const msg = bodyObj.error_msg || bodyObj.errorMsg || bodyObj.errMsg || "æœªçŸ¥é”™è¯¯";
                        log("ğŸ“ åŸå› ï¼š" + msg, "warn");
                     } catch(e) {
                         log("ğŸ“ è¯¦ç»†ï¼š" + result.body.substring(0, 100), "warn");
                     }
                 }
                 if (result.error) {
                     log("Worker é”™è¯¯ï¼š" + result.error, "error");
                 }
                 errors++;
                 if (!isAuto) btn.innerHTML = 'âŒ å¤±è´¥';
            }
            
        } catch (err) {
            log("ğŸ’¥ ä¸¥é‡é”™è¯¯ï¼š" + err.message, "error");
            errors++;
            if (!isAuto) btn.innerHTML = 'âŒ ç³»ç»Ÿé”™è¯¯';
        } finally {
            updateStats();
            if (!isAuto) {
                setTimeout(() => { 
                    if(!btn.innerHTML.includes('æ‰§è¡Œä¸­')) {
                        btn.classList.remove('loading'); 
                        if(btn.innerHTML.includes('âŒ')) {
                             setTimeout(() => btn.innerHTML = 'é‡è¯•ç¨‹åº', 2000);
                        } else {
                             setTimeout(() => btn.innerHTML = 'å•æ¬¡æ‰“å‡» // ç«‹å³æ‰§è¡Œ', 2000);
                        }
                    }
                }, 500);
            }
        }
    }

    function updateStats() {
        document.getElementById('reqCount').innerText = reqs;
        document.getElementById('errCount').innerText = errors;
    }
</script>
</body>
</html>
`;
